<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNSåŸŸåç®¡ç†ç³»ç»Ÿ - DDNSè®¾ç½®</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <style>
        /* DDNSå¼¹çª—å¸ƒå±€ä¼˜åŒ– */
        #ddnsModal .modal-content {
            max-height: 85vh;
            margin: 7.5vh auto;
            display: flex;
            flex-direction: column;
        }
        
        #ddnsModal .modal-header {
            flex-shrink: 0;
        }
        
        #ddnsModal .modal-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem 0;
        }
        
        #ddnsModal .modal-footer {
            flex-shrink: 0;
            border-top: 1px solid #eee;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        /* å¼ºåˆ¶è®¾ç½®ä¸»åŸŸåé¢„è§ˆä¸ºé»‘è‰² */
        #ddnsModal #domainPreview {
            color: #000 !important;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            #ddnsModal .modal-content {
                max-height: 90vh;
                margin: 5vh auto;
            }
        }
        
        @media (max-width: 480px) {
            #ddnsModal .modal-content {
                max-height: 85vh;
                margin: 7.5vh auto;
            }
        }
    </style>
</head>
<body>
    <!-- æ±‰å ¡èœå•æŒ‰é’® -->
    <button class="hamburger-menu" onclick="toggleSidebar()">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- å†…å®¹ä¸»ä½“ -->
        <div class="content-body">
            <!-- DDNSè®¾ç½®åŒºåŸŸ -->
            <div id="ddns" class="section active">
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ”„ DDNSè®¾ç½®</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="ddnsApp.updateAllDDNS(this)">
                                    ğŸ”„ æ‰¹é‡æ›´æ–°
                                </button>
                                <button class="btn btn-info" onclick="ddnsApp.showStatusSummary()">
                                    ğŸ“Š çŠ¶æ€æ¦‚è§ˆ
                                </button>
                            </div>
                            <button class="btn btn-primary" onclick="ddnsApp.showDDNSModal()">
                                â• æ·»åŠ DDNSé…ç½®
                            </button>
                        </div>
                        <div id="ddns-alert"></div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="text-align: center;">é…ç½®åç§°</th>
                                        <th style="text-align: center;">å®Œæ•´åŸŸå</th>
                                        <th style="text-align: center;">è®°å½•ç±»å‹</th>
                                        <th style="text-align: center;">å½“å‰IP</th>
                                        <th style="text-align: center;">æ›´æ–°é—´éš”</th>
                                        <th style="text-align: center;">æœ€åæ›´æ–°</th>
                                        <th style="text-align: center;">çŠ¶æ€</th>
                                        <th style="text-align: center;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="ddns-table">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modalContainer"></div>

    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="/static/js/components/sidebar.js"></script>
    <script src="/static/js/components/modal.js"></script>

    <script>
        class DDNSManager {
            constructor() {
                this.init();
            }

            init() {
                this.createModals();
                this.bindEvents();
                this.loadDDNSConfigs();
            }

            createModals() {
                // åˆ›å»ºDDNSé…ç½®æ¨¡æ€æ¡†
                if (!document.getElementById('ddnsModal')) {
                    this.ddnsModal = this.createDDNSModal();
                }
            }

            createDDNSModal() {
                const modalContent = `
                    <div class="modal" id="ddnsModal">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 id="ddnsModalTitle">æ·»åŠ DDNSé…ç½®</h3>
                                <span class="close">&times;</span>
                            </div>
                            <div class="modal-body">
                                <form id="ddnsForm">
                                    <div class="form-group">
                                        <label for="ddnsName">é…ç½®åç§°</label>
                                        <input type="text" id="ddnsName" required placeholder="å¦‚ï¼šå®¶åº­ç½‘ç»œã€åŠå…¬ç½‘ç»œç­‰">
                                    </div>
                                    <div class="form-group">
                                        <label for="ddnsDomain">é€‰æ‹©åŸŸå</label>
                                        <select id="ddnsDomain" required>
                                            <option value="">è¯·é€‰æ‹©åŸŸå</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="ddnsSubdomain">å­åŸŸå</label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; width: 100%;">
                                            <input type="text" id="ddnsSubdomain" required placeholder="å¦‚ï¼šhome, office, ddnsç­‰" 
                                                   style="flex: 0 0 56%;">
                                            <span id="domainPreview" style="color: #000; font-weight: 500; flex: 0 0 44%; padding-left: 0.5rem;"></span>
                                        </div>
                                        <small class="form-text">åªéœ€è¾“å…¥å­åŸŸåå‰ç¼€ï¼Œå®Œæ•´åŸŸåå°†è‡ªåŠ¨ç”Ÿæˆ</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ddnsRecordType">è®°å½•ç±»å‹</label>
                                        <select id="ddnsRecordType" required>
                                            <option value="1">A (IPv4)</option>
                                            <option value="2">AAAA (IPv6)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="ddnsUpdateInterval">æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰</label>
                                        <input type="number" id="ddnsUpdateInterval" min="60" value="300" required>
                                        <small class="form-text">æœ€å°é—´éš”60ç§’ï¼Œæ¨è300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="ddnsUpdateMethod">æ›´æ–°æ–¹å¼</label>
                                        <select id="ddnsUpdateMethod" required>
                                            <option value="auto">è‡ªåŠ¨æ›´æ–°</option>
                                            <option value="manual">æ‰‹åŠ¨æ›´æ–°</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="switch-container">
                                            <span>å¯ç”¨</span>
                                            <label class="switch">
                                                <input type="checkbox" id="ddnsEnabled" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </label>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <div style="text-align: right;">
                                    <button type="button" class="btn btn-secondary" onclick="ddnsApp.closeDDNSModal()">å–æ¶ˆ</button>
                                    <button type="submit" class="btn btn-primary" form="ddnsForm">ä¿å­˜</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                // ç»‘å®šäº‹ä»¶
                const modal = document.getElementById('ddnsModal');
                const closeBtn = modal.querySelector('.close');
                
                closeBtn.addEventListener('click', () => {
                    this.closeDDNSModal();
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeDDNSModal();
                    }
                });
                
                return modal;
            }

            bindEvents() {
                // æ¨¡æ€æ¡†å…³é—­
                document.querySelectorAll('.close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', (e) => {
                        this.closeModal(e.target.closest('.modal'));
                    });
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        this.closeModal(e.target);
                    }
                });

                // å»¶è¿Ÿç»‘å®šè¡¨å•æäº¤äº‹ä»¶
                setTimeout(() => {
                    const ddnsForm = document.getElementById('ddnsForm');
                    if (ddnsForm && !ddnsForm.dataset.bound) {
                        ddnsForm.addEventListener('submit', (e) => {
                            this.handleDDNSSubmit(e);
                        });
                        ddnsForm.dataset.bound = 'true';
                    }
                    
                    // ç»‘å®šåŸŸåé€‰æ‹©å˜åŒ–äº‹ä»¶
                    const domainSelect = document.getElementById('ddnsDomain');
                    if (domainSelect && !domainSelect.dataset.bound) {
                        domainSelect.addEventListener('change', () => {
                            this.updateFullDomainPreview();
                        });
                        domainSelect.dataset.bound = 'true';
                    }
                    
                    // ç»‘å®šå­åŸŸåè¾“å…¥å˜åŒ–äº‹ä»¶
                    const subdomainInput = document.getElementById('ddnsSubdomain');
                    if (subdomainInput && !subdomainInput.dataset.bound) {
                        subdomainInput.addEventListener('input', () => {
                            this.updateFullDomainPreview();
                        });
                        subdomainInput.dataset.bound = 'true';
                    }
                }, 100);
            }

            async loadDDNSConfigs() {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/ddns/', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const configs = await response.json();
                    this.renderDDNSConfigs(configs);
                } catch (error) {
                    this.showAlert('ddns-alert', 'åŠ è½½DDNSé…ç½®å¤±è´¥: ' + error.message, 'error');
                }
            }

            renderDDNSConfigs(configs) {
                const tbody = document.getElementById('ddns-table');
                tbody.innerHTML = '';

                if (configs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">æš‚æ— DDNSé…ç½®</td></tr>';
                    return;
                }

                configs.forEach(config => {
                    const row = document.createElement('tr');
                    const statusClass = config.enabled ? 'enabled' : 'disabled';
                    const statusText = config.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
                    const fullDomain = config.subdomain; // ç›´æ¥ä½¿ç”¨å®Œæ•´åŸŸåï¼Œä¸å†æ‹¼æ¥
                    const recordTypeText = config.record_type === 1 ? 'A' : 'AAAA';
                    const lastUpdate = config.last_update_at ? 
                        new Date(config.last_update_at).toLocaleString() : 'ä»æœªæ›´æ–°';
                    const updateInterval = this.formatInterval(config.update_interval);

                    row.innerHTML = `
                        <td style="text-align: center; vertical-align: middle;">${config.name}</td>
                        <td style="text-align: center; vertical-align: middle;">${fullDomain}</td>
                        <td style="text-align: center; vertical-align: middle;">${recordTypeText}</td>
                        <td style="text-align: center; vertical-align: middle;">${config.last_ip || '-'}</td>
                        <td style="text-align: center; vertical-align: middle;">${updateInterval}</td>
                        <td style="text-align: center; vertical-align: middle;">${lastUpdate}</td>
                        <td style="text-align: center; vertical-align: middle;">
                            <span class="status ${statusClass}" style="display: inline-block; white-space: nowrap;">${statusText}</span>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn btn-primary" data-config-id="${config.id}" onclick="ddnsApp.updateDDNS(this.dataset.configId, this)">
                                ğŸ”„ æ›´æ–°
                            </button>
                            <button class="btn btn-info" data-config-id="${config.id}" data-config-name="${config.name.replace(/'/g, '&apos;').replace(/"/g, '&quot;')}" onclick="ddnsApp.viewDDNSLogs(this.dataset.configId, this.dataset.configName)">
                                ğŸ“Š æ—¥å¿—
                            </button>
                            <button class="btn btn-secondary" data-config-id="${config.id}" onclick="ddnsApp.editDDNS(this.dataset.configId)">
                                âœï¸ ç¼–è¾‘
                            </button>
                            <button class="btn btn-danger" data-config-id="${config.id}" onclick="ddnsApp.deleteDDNS(this.dataset.configId, this)">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            formatInterval(seconds) {
                if (seconds < 60) return `${seconds}ç§’`;
                if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿ`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}å°æ—¶`;
                return `${Math.floor(seconds / 86400)}å¤©`;
            }

            updateFullDomainPreview() {
                const domainSelect = document.getElementById('ddnsDomain');
                const subdomainInput = document.getElementById('ddnsSubdomain');
                const previewSpan = document.getElementById('domainPreview');
                
                if (!domainSelect || !subdomainInput || !previewSpan) return;
                
                const selectedDomain = domainSelect.value;
                const subdomain = subdomainInput.value.trim();
                
                if (selectedDomain && subdomain) {
                    // ä»é€‰é¡¹æ–‡æœ¬ä¸­æå–åŸŸåï¼ˆå»æ‰æœåŠ¡å•†åç§°ï¼‰
                    const optionText = domainSelect.options[domainSelect.selectedIndex].text;
                    const domainName = optionText.split(' (')[0]; // å»æ‰æœåŠ¡å•†åç§°éƒ¨åˆ†
                    previewSpan.textContent = `.${domainName}`;
                    previewSpan.style.color = '#333';
                } else if (selectedDomain) {
                    const optionText = domainSelect.options[domainSelect.selectedIndex].text;
                    const domainName = optionText.split(' (')[0];
                    previewSpan.textContent = `.${domainName}`;
                    previewSpan.style.color = '#999';
                } else {
                    previewSpan.textContent = '';
                }
            }

            async loadDomainSelect() {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/domains/', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const domains = await response.json();
                    
                    const select = document.getElementById('ddnsDomain');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©åŸŸå</option>';
                    
                    domains.forEach(domain => {
                        const option = document.createElement('option');
                        option.value = domain.id;
                        option.textContent = `${domain.name} (${domain.provider.name})`;
                        select.appendChild(option);
                    });
                } catch (error) {
                    this.showAlert('ddns-alert', 'åŠ è½½åŸŸååˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                }
            }

            async showDDNSModal(configId = null) {
                this.currentConfigId = configId;
                
                await this.loadDomainSelect();
                
                const modal = document.getElementById('ddnsModal');
                const title = document.getElementById('ddnsModalTitle');
                const form = document.getElementById('ddnsForm');

                if (configId) {
                    title.textContent = 'ç¼–è¾‘DDNSé…ç½®';
                    await this.loadDDNSData(configId);
                } else {
                    title.textContent = 'æ·»åŠ DDNSé…ç½®';
                    form.reset();
                    document.getElementById('ddnsEnabled').checked = true;
                }

                modal.style.display = 'block';
                
                // åˆå§‹åŒ–åŸŸåé¢„è§ˆ
                setTimeout(() => {
                    this.updateFullDomainPreview();
                }, 100);
            }

            async loadDDNSData(configId) {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch(`/api/ddns/${configId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const config = await response.json();

                    document.getElementById('ddnsName').value = config.name;
                    document.getElementById('ddnsDomain').value = config.domain_id;
                    
                    // æå–å­åŸŸåå‰ç¼€ï¼ˆå»æ‰ä¸»åŸŸåéƒ¨åˆ†ï¼‰
                    const domainName = config.domain.name;
                    let subdomainPrefix = config.subdomain;
                    if (subdomainPrefix.endsWith(`.${domainName}`)) {
                        subdomainPrefix = subdomainPrefix.replace(`.${domainName}`, '');
                    }
                    document.getElementById('ddnsSubdomain').value = subdomainPrefix;
                    
                    document.getElementById('ddnsRecordType').value = config.record_type;
                    document.getElementById('ddnsUpdateInterval').value = config.update_interval;
                    document.getElementById('ddnsUpdateMethod').value = config.update_method;
                    document.getElementById('ddnsEnabled').checked = config.enabled;
                    
                    // æ›´æ–°åŸŸåé¢„è§ˆ
                    setTimeout(() => {
                        this.updateFullDomainPreview();
                    }, 100);
                } catch (error) {
                    this.showAlert('ddns-alert', 'åŠ è½½DDNSé…ç½®å¤±è´¥: ' + error.message, 'error');
                }
            }

            closeDDNSModal() {
                document.getElementById('ddnsModal').style.display = 'none';
                this.currentConfigId = null;
            }

            async handleDDNSSubmit(e) {
                e.preventDefault();

                // é€šè¿‡formå±æ€§æ‰¾åˆ°æäº¤æŒ‰é’®
                const submitButton = document.querySelector('button[form="ddnsForm"]');
                if (submitButton) {
                    // æ˜¾ç¤ºæŒ‰é’®åŠ è½½åŠ¨ç”»
                    this.showLoadingSpinner(submitButton, 'ä¿å­˜ä¸­...');
                }

                // æ„å»ºå®Œæ•´åŸŸå
                const domainSelect = document.getElementById('ddnsDomain');
                const subdomainInput = document.getElementById('ddnsSubdomain').value.trim();
                const optionText = domainSelect.options[domainSelect.selectedIndex].text;
                const domainName = optionText.split(' (')[0]; // å»æ‰æœåŠ¡å•†åç§°éƒ¨åˆ†
                const fullSubdomain = `${subdomainInput}.${domainName}`;

                const formData = {
                    name: document.getElementById('ddnsName').value,
                    domain_id: parseInt(document.getElementById('ddnsDomain').value),
                    subdomain: fullSubdomain,
                    record_type: parseInt(document.getElementById('ddnsRecordType').value),
                    update_interval: parseInt(document.getElementById('ddnsUpdateInterval').value),
                    update_method: document.getElementById('ddnsUpdateMethod').value,
                    enabled: document.getElementById('ddnsEnabled').checked
                };

                try {
                    const token = localStorage.getItem('access_token');
                    const url = this.currentConfigId ? `/api/ddns/${this.currentConfigId}` : '/api/ddns/';
                    const method = this.currentConfigId ? 'PUT' : 'POST';

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        this.showAlert('ddns-alert', 'ä¿å­˜æˆåŠŸ', 'success');
                        this.closeDDNSModal();
                        this.loadDDNSConfigs();
                    } else {
                        const error = await response.json();
                        this.showAlert('ddns-alert', 'ä¿å­˜å¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    this.showAlert('ddns-alert', 'ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                } finally {
                    // éšè—æŒ‰é’®åŠ è½½åŠ¨ç”»
                    const submitButton = document.querySelector('button[form="ddnsForm"]');
                    if (submitButton) {
                        this.hideLoadingSpinner(submitButton);
                    }
                }
            }

            async updateDDNS(configId, buttonElement = null) {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await this.apiCall(`/api/ddns/${configId}/update`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }, buttonElement, 'æ›´æ–°ä¸­...');

                    if (response.ok) {
                        const result = await response.json();
                        this.showAlert('ddns-alert', result.message, 'success');
                        this.loadDDNSConfigs();
                    } else {
                        const error = await response.json();
                        this.showAlert('ddns-alert', 'æ›´æ–°å¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    this.showAlert('ddns-alert', 'æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                }
            }

            async updateAllDDNS(buttonElement = null) {
                if (!confirm('ç¡®å®šè¦æ‰¹é‡æ›´æ–°æ‰€æœ‰å¯ç”¨çš„DDNSé…ç½®å—ï¼Ÿ')) return;

                try {
                    const token = localStorage.getItem('access_token');
                    const response = await this.apiCall('/api/ddns/update-all', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }, buttonElement, 'æ‰¹é‡æ›´æ–°ä¸­...');

                    if (response.ok) {
                        const result = await response.json();
                        this.showAlert('ddns-alert', result.message, 'success');
                        this.loadDDNSConfigs();
                    } else {
                        const error = await response.json();
                        this.showAlert('ddns-alert', 'æ‰¹é‡æ›´æ–°å¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    this.showAlert('ddns-alert', 'æ‰¹é‡æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                }
            }

            async showStatusSummary() {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch('/api/ddns/status/summary', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const status = await response.json();
                    
                    let statusText = 'DDNSçŠ¶æ€æ¦‚è§ˆ:\n\n';
                    statusText += `æ€»é…ç½®æ•°: ${status.total_configs}\n`;
                    statusText += `å¯ç”¨é…ç½®: ${status.enabled_configs}\n`;
                    statusText += `ç¦ç”¨é…ç½®: ${status.disabled_configs}\n`;
                    statusText += `24å°æ—¶å†…æˆåŠŸæ›´æ–°: ${status.recent_updates}\n`;
                    statusText += `24å°æ—¶å†…æ›´æ–°å¤±è´¥: ${status.recent_failures}\n`;
                    statusText += `æ£€æŸ¥æ—¶é—´: ${new Date(status.last_check).toLocaleString()}`;
                    
                    alert(statusText);
                } catch (error) {
                    this.showAlert('ddns-alert', 'è·å–çŠ¶æ€æ¦‚è§ˆå¤±è´¥: ' + error.message, 'error');
                }
            }

            async viewDDNSLogs(configId, configName) {
                try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch(`/api/ddns/${configId}/logs?page=1&page_size=20`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    
                    this.showDDNSLogsModal(configName, data, configId);
                } catch (error) {
                    this.showAlert('ddns-alert', 'è·å–DDNSæ—¥å¿—å¤±è´¥: ' + error.message, 'error');
                }
            }

            showDDNSLogsModal(configName, data, configId) {
                const logs = data.logs;
                const pagination = data.pagination;
                
                let logsHtml = '';
                if (logs.length === 0) {
                    logsHtml = '<p style="text-align: center; color: #666;">æš‚æ— æ›´æ–°æ—¥å¿—</p>';
                } else {
                    logsHtml = `
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="text-align: center;">æ—¶é—´</th>
                                        <th style="text-align: center;">æ—§IP</th>
                                        <th style="text-align: center;">æ–°IP</th>
                                        <th style="text-align: center;">çŠ¶æ€</th>
                                        <th style="text-align: center;">æ¶ˆæ¯</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    logs.forEach(log => {
                        const statusClass = log.status === 'success' ? 'enabled' : 'disabled';
                        const statusText = log.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                        logsHtml += `
                            <tr>
                                <td style="text-align: center; vertical-align: middle;">${new Date(log.created_at).toLocaleString()}</td>
                                <td style="text-align: center; vertical-align: middle;">${log.old_ip || '-'}</td>
                                <td style="text-align: center; vertical-align: middle;">${log.new_ip || '-'}</td>
                                <td style="text-align: center; vertical-align: middle;"><span class="status ${statusClass}">${statusText}</span></td>
                                <td style="text-align: center; vertical-align: middle;">${log.message}</td>
                            </tr>
                        `;
                    });
                    
                    logsHtml += '</tbody></table></div>';
                }

                const modalContent = `
                    <div class="modal" id="ddnsLogsModal" style="display: block;">
                        <div class="modal-content" style="max-width: 90vw; max-height: 80vh;">
                            <div class="modal-header">
                                <h3>DDNSæ›´æ–°æ—¥å¿— - ${configName}</h3>
                                <span class="close" onclick="ddnsApp.closeDDNSLogsModal()">&times;</span>
                            </div>
                            <div class="modal-body" style="overflow-y: auto;">
                                ${logsHtml}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
            }

            closeDDNSLogsModal() {
                const modal = document.getElementById('ddnsLogsModal');
                if (modal) {
                    modal.remove();
                }
            }

            editDDNS(configId) {
                this.showDDNSModal(configId);
            }

            async deleteDDNS(configId, buttonElement = null) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªDDNSé…ç½®å—ï¼Ÿ')) return;

                try {
                    const token = localStorage.getItem('access_token');
                    const response = await this.apiCall(`/api/ddns/${configId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }, buttonElement, 'åˆ é™¤ä¸­...');

                    if (response.ok) {
                        this.showAlert('ddns-alert', 'åˆ é™¤æˆåŠŸ', 'success');
                        this.loadDDNSConfigs();
                    } else {
                        const error = await response.json();
                        this.showAlert('ddns-alert', 'åˆ é™¤å¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    this.showAlert('ddns-alert', 'åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            }

            // å·¥å…·æ–¹æ³•
            showAlert(containerId, message, type) {
                const container = document.getElementById(containerId);
                container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;

                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }

            closeModal(modal) {
                modal.style.display = 'none';
            }

            showLoadingSpinner(button, text = 'å¤„ç†ä¸­...') {
                button.dataset.originalText = button.textContent;
                button.dataset.originalDisabled = button.disabled;
                
                button.disabled = true;
                button.innerHTML = `
                    <span style="display: inline-block; width: 16px; height: 16px; margin-right: 8px;">
                        <svg style="animation: spin 1s linear infinite; width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"/>
                            <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"/>
                        </svg>
                    </span>
                    ${text}
                `;
            }

            hideLoadingSpinner(button) {
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                    button.disabled = button.dataset.originalDisabled === 'true';
                    delete button.dataset.originalText;
                    delete button.dataset.originalDisabled;
                }
            }

            showGlobalLoading(text = 'å¤„ç†ä¸­...') {
                // åˆ›å»ºå…¨å±€åŠ è½½é®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.id = 'globalLoadingOverlay';
                overlay.className = 'global-loading-overlay';
                overlay.innerHTML = `
                    <div class="global-loading-content">
                        <div class="global-loading-spinner"></div>
                        <div class="global-loading-text">${text}</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            hideGlobalLoading() {
                const overlay = document.getElementById('globalLoadingOverlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            async apiCall(url, options = {}, buttonElement = null, loadingText = 'å¤„ç†ä¸­...') {
                if (buttonElement) {
                    this.showLoadingSpinner(buttonElement, loadingText);
                }

                try {
                    const response = await fetch(url, options);
                    return response;
                } finally {
                    if (buttonElement) {
                        this.hideLoadingSpinner(buttonElement);
                    }
                }
            }
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }
        
        // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }
        
        // å…¨å±€å˜é‡
        let ddnsApp;
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            // åˆå§‹åŒ–DDNSç®¡ç†å™¨
            ddnsApp = new DDNSManager();
            window.ddnsApp = ddnsApp;
            
            // åˆ›å»ºä¾§è¾¹æ 
            const sidebar = new Sidebar();
            
            // å»¶è¿Ÿè®¾ç½®DDNSä¸ºå½“å‰æ´»è·ƒé¡µé¢
            setTimeout(() => {
                const ddnsNavItem = document.querySelector('[href="/ddns"]');
                if (ddnsNavItem) {
                    // æ¸…é™¤å…¶ä»–æ´»è·ƒçŠ¶æ€
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    // è®¾ç½®å½“å‰é¡µé¢ä¸ºæ´»è·ƒ
                    ddnsNavItem.classList.add('active');
                }
            }, 100);
        });
    </script>
</body>
</html>
